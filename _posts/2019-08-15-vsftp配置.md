---
title: vsftp 配置
date: 2019-08-15 09:39:54 +0800
layout: post
categories: linux
tags: [linux, vsftp]
---

## vsftpd虚拟用户的配置

配置vsftpd的虚拟用户简单分为两个方面

1. 配置pam模块                                    (见下方小标题)
2. 创建认证信息文件(passwd文件)     (见下方小标题)

## 选项简介

``nopriv_user=nobody`` -- 当vsftpd什么都不需要的时候, 会使用此用户的权限等级, 建议此用户无任何特殊权限, *这样即便vsftpd被黑掉, 黑客也是什么都干不了*

``secure_chroot_dir`` -- 当vsftpd不再需要访问文件系统时, 会chroot到这个目录. 此目录应当是空的, 并且不应当被ftp用户可写

``pam_service_name=vsftpd `` -- 即``/etc/pam.d/``目录下的vsftpd所用的pam配置的文件

## PAM模块

pam (*Pluggable Authentication Modules*)为应用和服务提供动态的认证支持, pam模块一般在``/lib/security/``或``/lib/(arch_type)/security``下.

### 仅虚拟用户的PAM

```
# 文件为 /etc/pam.d/vsftpd

# 使用 pam_pwdfile.so 模块来进行虚拟用户的认证, 使用的文件为/etc/vsftpd/.passwd
# 且文件内容格式为每行起始为用户名, 冒号分隔, 后接md5加密后的密码. example:
# test:$1$aT64AHTK$/xRnwvHafFmTzo6GpaCZL/
auth required pam_pwdfile.so pwdfile /etc/vsftpd/.passwd
account required pam_permit.so
```

### 仅本地用户的PAM

一般默认的pam文件即可实现仅本地用户认证, 保持默认即可, 不同的系统的默认pam文件内容也不同

**Arch Linux**

```
#%PAM-1.0
#
auth       required	/lib/security/pam_listfile.so item=user sense=deny file=/etc/ftpusers onerr=succeed
auth       required	/lib/security/pam_unix.so shadow nullok
auth       required	/lib/security/pam_shells.so
account    required	/lib/security/pam_unix.so
session    required	/lib/security/pam_unix.so

```

**Ubuntu WSL**

```
## Standard behaviour for ftpd(8).
#auth   required        pam_listfile.so item=user sense=deny file=/etc/ftpusers onerr=succeed
#
## Note: vsftpd handles anonymous logins on its own. Do not enable pam_ftp.so.
#
## Standard pam includes

@include common-account
@include common-session
@include common-auth
auth   required        pam_shells.so
```

### 同时允许本地和虚拟用户的PAM

由于Arch Linux和Ubuntu默认的PAM文件不一样, 所以两个配置有所不同.

如果简单地允许本地和虚拟用户的PAM加在一起, 结果并不是同时允许本地用户和虚拟用户, 因为文档中描述``required``和``requisite``都会在验证失败时直接返回失败, 而``sufficient``在本次验证失败, 则会继续进行后续模块的验证, 所以我的做法是将虚拟用户的验证模块由``required``变更为``sufficient``后添加到本地用户验证模块之前.[^1]

> - required
>      failure of such a PAM will ultimately lead to the PAM-API returning failure   but only after the remaining stacked modules (for this service and type)   have been invoked
> - requisite
>      like required, however, in the case that such a module returns a failure,   control is directly returned to the application. 
> - sufficient
>      success of such a module is enough to satisfy the authentication   requirements of the stack of modules (if a prior required module has failed   the success of this one is ignored). A failure of this module is not deemed   as fatal to satisfying the application that this type has succeeded. If the   module succeeds the PAM framework returns success to the application   immediately without trying any other modules.

**Arch Linux**

``pam_pwdfile``模块需要在[archlinux.org](archlinux.org)中的AUR自行安装

```
#%PAM-1.0
#
auth       sufficient /lib/security/pam_pwdfile.so pwdfile /etc/vsftpd/.passwd
account    sufficient /lib/security/pam_permit.so

auth       required	/lib/security/pam_listfile.so item=user sense=deny file=/etc/ftpusers onerr=succeed
auth       required	/lib/security/pam_unix.so shadow nullok
auth       required	/lib/security/pam_shells.so
account    required	/lib/security/pam_unix.so
session    required	/lib/security/pam_unix.so
```

**Ubuntu WSL**

Ubuntu WSL 的配置直接将虚拟用户认证模块粘贴到``@include``之前不能达到期望的结果, 于是参照 Arch Linux 的配置改为如下后成功,

```
auth     sufficient pam_pwdfile.so pwdfile /etc/vsftpd/.passwd
account  sufficient pam_permit.so

auth required pam_listfile.so item=user sense=deny file=/etc/vsftpd.ftpusers onerr=succeed
auth required pam_unix.so shadow nullok
auth required pam_shells.so
account required pam_unix.so
session required pam_unix.so
```

## 虚拟用户的passwd文件

这个文件的路径和文件名都写在pam模块中, 如同时允许虚拟用户和本地用户登录的Arch Linux的pam配置的第一行有效行

文件格式就是每行以用户名为起始, 冒号分隔, 后接MD5加密的密码

密码加密可以使用``openssl passwd -1 -noverify ${yourPasswd}``来加密, 只需要将此命令的输出作为加密后密码追加在冒号之后即可

## 报错总结

**500 OOPS: cannot locate user entry:**[^2]

如果是虚拟用户登录时报错, 需要检查``guest_enable``选项是否为``YES``以及``guest_username``是否合法; 如果是本地用户, 则需要检查是否时用户名拼写错误

[^1]: https://www.linuxquestions.org/questions/linux-software-2/how-to-enable-both-virtual-and-local-vsftpd-logins-with-pam-365860/
[^2]: https://ubuntuforums.org/showthread.php?t=1679782